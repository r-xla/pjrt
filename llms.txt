# pjrt

The {pjrt} package provides an R interface to
[PJRT](https://github.com/openxla/pjrt) (Pretty much Just another
RunTime), which allows you to *run* [XLA](https://openxla.org/) and
[stableHLO](https://openxla.org/stablehlo) programs on various hardware
backends. These programs are framework and hardware agnostic, which
means they can be generated by ML frameworks such as jax, and run by
PJRT on a specified backend (CPU, GPU, etc.). For a low-level R
interface to *create* stableHLO programs, see the
[stablehlo](https://github.com/r-xla/stablehlo) package.

## Installation

From GitHub:

``` r
pak::pak("r-xla/pjrt")
```

You can also install from
[r-universe](https://r-xla.r-universe.dev/builds), by adding the code
below to your `.Rprofile`.

``` r
options(repos = c(
  rxla = "https://r-xla.r-universe.dev",
  CRAN = "https://cloud.r-project.org/"
))
```

## Quick Start

Below, we create and run a stableHLO program that adds two `f32` tensors
of shape `(2, 2)`.

``` r
library(pjrt)
src <- r"(
func.func @main(
  %x: tensor<2x2xf32>,
  %y: tensor<2x2xf32>
) -> tensor<2x2xf32> {
  %0 = "stablehlo.add"(%x, %y) : (tensor<2x2xf32>, tensor<2x2xf32>) -> tensor<2x2xf32>
  "func.return"(%0): (tensor<2x2xf32>) -> ()
}
)"
program <- pjrt_program(src, format = "mlir")
program
#> PJRTProgram(format=mlir, code_size=221)
#> 
#> func.func @main(
#>   %x: tensor<2x2xf32>,
#>   %y: tensor<2x2xf32>
#> ) -> tensor<2x2xf32> {
#> ...
executable <- pjrt_compile(program, client = "cpu")

x <- pjrt_buffer(c(1, 2, 3, 4), shape = c(2, 2), dtype = "f32")
x
#> PJRTBuffer 
#>  1.0000 3.0000
#>  2.0000 4.0000
#> [ CPUf32{2x2} ]
y <- pjrt_buffer(c(5, 6, 7, 8), shape = c(2, 2), dtype = "f32")
y
#> PJRTBuffer 
#>  5.0000 7.0000
#>  6.0000 8.0000
#> [ CPUf32{2x2} ]

pjrt_execute(executable, x, y)
#> PJRTBuffer 
#>   6.0000 10.0000
#>   8.0000 12.0000
#> [ CPUf32{2x2} ]
```

## Main Features

- Compile stableHLO programs into hardware-specific executables.
- Provide a runtime to execute compiled programs.
- Convert buffers to and from R arrays and vectors.
- Read and write buffers using the
  [safetensors](https://github.com/mlverse/safetensors) format.

## Platform Support

- **Linux**
  - ✅ CPU backend is fully supported.
  - ✅ CUDA (NVIDIA GPU) backend is fully supported.
- **Windows**
  - ✅ CPU backend is fully supported.
  - ⚠️ GPU is only supported via Windows Subsystem for Linux (WSL2).
- **macOS**
  - ✅ CPU backend is supported.
  - ⚠️ Metal (Apple GPU) backend is available but not fully functional.

## Acknowledgements

- The development of this package is supported by
  [MaRDI](https://www.mardi4nfdi.de/about/mission).
- Without [OpenXLA](https://openxla.org/), none of this would be
  possible.
- The design of the {pjrt} package was inspired by the
  [gopjrt](https://github.com/gomlx/gopjrt) implementation.
- The project also uses various components from OpenXLA:
  - [PJRT C
    API](https://github.com/openxla/xla/blob/main/xla/pjrt/c/pjrt_c_api.h).
  - [PJRT C API FFI
    Extension](https://github.com/openxla/xla/blob/main/xla/pjrt/c/pjrt_c_api_ffi_extension.h).
  - Various protobuf files, see `./tools/copy-proto.R` for which ones.
  - Plugin implementations for CPU and CUDA (we are using the builds
    from [zml/pjrt-artifacts](https://github.com/zml/pjrt-artifacts/)).
- For Metal, we are using the plugin implementation from
  [jax-metal](https://pypi.org/project/jax-metal/).

# Package index

## All functions

- [`as.character(`*`<PJRTElementType>`*`)`](as.character.PJRTElementType.md)
  :

  Convert `PJRTElementType` to string

- [`as_pjrt_client()`](as_pjrt_client.md) : Convert to PJRT Client

- [`as_pjrt_plugin()`](as_pjrt_plugin.md) : Convert to PJRT Plugin

- [`devices()`](devices.md) : Devices

- [`elt_type()`](elt_type.md) : Element Type

- [`format_buffer()`](format_buffer.md) : Format Buffer Data

- [`lazy_buffer_ready()`](lazy_buffer_ready.md) : Check if a lazy buffer
  is ready

- [`pjrt`](pjrt-package.md) [`pjrt-package`](pjrt-package.md) : pjrt: R
  Interface to PJRT

- [`pjrt_buffer()`](pjrt_buffer.md) [`pjrt_scalar()`](pjrt_buffer.md)
  [`pjrt_empty()`](pjrt_buffer.md) : Create a PJRT Buffer

- [`pjrt_client()`](pjrt_client.md) : Create a Client

- [`pjrt_compile()`](pjrt_compile.md) : Compile a Program

- [`pjrt_device()`](pjrt_device.md) : Create a PJRT Device

- [`pjrt_execute()`](pjrt_execute.md) : Execute a PJRT program

- [`pjrt_execute_lazy()`](pjrt_execute_lazy.md) : Execute a PJRT program
  asynchronously

- [`pjrt_execution_options()`](pjrt_execution_options.md) : Create
  Execution Options

- [`pjrt_lazy_buffer_materialize()`](pjrt_lazy_buffer_materialize.md) :
  Materialize a lazy buffer into a regular PJRTBuffer

- [`pjrt_plugin()`](pjrt_plugin.md) : Create PJRT Plugin

- [`pjrt_program()`](pjrt_program.md) :

  Create a `PJRTProgram`

- [`platform()`](platform.md) : Platform Name

- [`plugin_attributes()`](plugin_attributes.md) : Get Plugin Attributes

- [`print(`*`<PJRTBuffer>`*`)`](print.PJRTBuffer.md) : Print a PJRT
  Buffer

